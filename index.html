<link href="https://fonts.googleapis.com/css2?family=Nabla&family=Sixtyfour+Convergence&display=swap" rel="stylesheet">
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda de Videojuegos - GAME PRIME</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://kit.fontawesome.com/f4c52f4663.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body onload="iniciarPagina()">
    <header class="header"> 
        <div class="logo">
            <img src="imagenes/logo.png" alt="logo" class="logo">
        </div>
        <nav> 
            <ul class="nav-links">
                <li><a href="ofertas.html">Ofertas</a></li>
                <li><a href="contactanos.html">Contacto</a></li>
                <li><a href="carrito.html">Carrito</a></li>
                <li><a href="login-registro.html" id="loginLink">Iniciar Sesi√≥n</a></li>
                <li style="display:none;" id="userInfo">
                    <span id="userName" style="color:#ff007f; font-weight:bold;"></span>
                    <button onclick="cerrarSesion()" style="background:#ff007f; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; margin-left:10px;">Cerrar Sesi√≥n</button>
                </li>
            </ul>
            <div class="hamburger" onclick="toggleMenu()">
                <div class="line"></div>
                <div class="line"></div>
                <div class="line"></div>
            </div>
        </nav>
    </header>

    <main class="fondo-0">
        <section class="banner">
            <img id="img_banner" src="imagenes/banner1.jpg" alt="Videojuegos destacados">
        </section>
        <div class="filtro">
        <h3>Filtrar por Categor√≠a:</h3>
            <div class="categoria">
                <select id="categoria-juegos" name="categoria-juegos" onchange="filtrarJuegos()">
                    <option value="">Todos los Juegos</option>
                    <option value="accion">Acci√≥n</option>
                    <option value="aventura">Aventura</option>
                    <option value="rol">Rol</option>
                    <option value="deportes">Deportes</option>
                </select>
            </div>
        </div>
        <section class="productos" id="juegos-lista">
            <div class="grid-layout">   
            </div>    
        </section>
    </main>

    <!-- Modal for product details -->
    <div id="productModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modal-body">
                <!-- Product details will be loaded here -->
            </div>
        </div>
    </div>

    <footer class="pie-pagina">
        <div class="grupo-1">
            <div class="box">
                <figure>
                    <a href="reclamaciones.html">
                        <img src="imagenes/libro_de_reclamaciones.png" alt="libro de reclamaciones">
                    </a>
                </figure>
            </div>
            <div class="box">
                <h2>SOBRE NOSOTROS</h2>
                <p>Nuestra idea nace de la experiencia propia al comprar videojuegos, garantizando confianza porque hemos estado en tu lugar.</p>
                <p>Fundada en 2024, nos comprometemos a ofrecer siempre las mejores ofertas.</p>
            </div>
            <div class="box">
                <h2>SIGUENOS</h2>
                <div class="red-social">
                    <a href="https://www.facebook.com/?locale=es_LA" class="fa fa-facebook"></a>
                    <a href="https://www.instagram.com/" class="fa fa-instagram"></a>
                    <a href="https://x.com/?lang=es" class="fa fa-twitter"></a>
                    <a href="https://www.youtube.com/" class="fa fa-youtube"></a>
                </div>
            </div>
        </div>
        <div class="grupo-2">
            <small>&copy; 2024 <b>GAME PRIME</b> - Todos los Derechos Reservados.</small>
        </div>
    </footer>
    <script src="script_sesion.js"></script>
    <script src="script.js"></script>
    <script>
        // Verificar sesi√≥n activa al cargar la p√°gina
        function verificarSesion() {
            const userEmail = localStorage.getItem('user_email');
            const userNombre = localStorage.getItem('user_nombre');
            const userRol = localStorage.getItem('user_rol');

            if (userEmail && userNombre) {
                // Usuario tiene sesi√≥n activa
                console.log('‚úÖ Sesi√≥n activa detectada:', userEmail, 'Rol:', userRol);
                document.getElementById('loginLink').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userName').textContent = '¬°Hola, ' + userNombre + '!';
            } else {
                // No hay sesi√≥n
                console.log('‚ùå No hay sesi√≥n activa');
                document.getElementById('loginLink').style.display = 'block';
                document.getElementById('userInfo').style.display = 'none';
            }
        }

        function cerrarSesion() {
            // Limpiar localStorage
            localStorage.removeItem('supabase_session');
            localStorage.removeItem('user_email');
            localStorage.removeItem('user_rol');
            localStorage.removeItem('user_nombre');
            
            console.log('üîì Sesi√≥n cerrada');
            alert('Sesi√≥n cerrada correctamente');
            
            // Redirigir al login
            window.location.href = 'login-registro.html';
        }

        // Verificar sesi√≥n al cargar la p√°gina
        verificarSesion();

        let products = [];

        async function loadProducts() {
            try {
                const response = await fetch('/api/productos');
                products = await response.json();
                const container = document.getElementById('juegos-lista').querySelector('.grid-layout');
                container.innerHTML = '';
                products.forEach(producto => {
                    const div = document.createElement('div');
                    div.className = 'producto-item';
                    div.setAttribute('data-categoria', producto.categoria.toLowerCase());
                    div.innerHTML = `
                        <img src="imagenes/${producto.portada}" alt="${producto.titulo}">
                        <h3>${producto.titulo}</h3>
                        <button onclick="showProductModal(${producto.id})">Ver M√°s</button>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function showProductModal(id) {
            const product = products.find(p => p.id == id);
            if (!product) return;

            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div class="product-container" style="background-color: rgba(25, 25, 25, 0.85); padding:20px; border-radius:10px; color: white; max-width:1000px; margin:0 auto;">
                    <div class="top-section" style="display:flex; gap:20px;">
                        <div class="left-column" style="flex:0 0 70%;">
                            <video id="main-video" controls style="width:100%; max-width:600px; margin-bottom:20px;">
                                <source src="video/${product.video}" type="video/mp4">
                            </video>
                            <img id="main-image" style="width:100%; max-width:600px; display:none; margin-bottom:20px;" alt="Imagen del producto">
                            <div class="thumbnails" style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;">
                                <div class="thumbnail" onclick="changeViewer('video')" style="cursor:pointer; border:2px solid #ff007f; padding:5px;">
                                    <span>Video</span>
                                </div>
                                <img src="imagenes/${product.imagen1}" class="thumbnail" onclick="changeViewer('image', 'imagenes/${product.imagen1}')" style="width:80px; height:60px; object-fit:cover; cursor:pointer; border:2px solid transparent;">
                                <img src="imagenes/${product.imagen2}" class="thumbnail" onclick="changeViewer('image', 'imagenes/${product.imagen2}')" style="width:80px; height:60px; object-fit:cover; cursor:pointer; border:2px solid transparent;">
                                <img src="imagenes/${product.imagen3}" class="thumbnail" onclick="changeViewer('image', 'imagenes/${product.imagen3}')" style="width:80px; height:60px; object-fit:cover; cursor:pointer; border:2px solid transparent;">
                                <img src="imagenes/${product.imagen4}" class="thumbnail" onclick="changeViewer('image', 'imagenes/${product.imagen4}')" style="width:80px; height:60px; object-fit:cover; cursor:pointer; border:2px solid transparent;">
                            </div>
                            <div class="tabs">
                                <button onclick="showTab('descripcion')" style="background:#ff007f; color:white; border:none; padding:10px; margin-right:10px; cursor:pointer;">Descripci√≥n</button>
                                <button onclick="showTab('contenido')" style="background:#333; color:white; border:none; padding:10px; cursor:pointer;">Contenido</button>
                                <div id="tab-descripcion" class="tab-content" style="margin-top:10px;">
                                    <table style="width:100%; border-collapse:collapse;">
                                        <tr>
                                            <th style="border:1px solid #ddd; padding:8px; color:black;">Descripci√≥n</th>
                                            <th style="border:1px solid #ddd; padding:8px; color:black;">Contenido</th>
                                        </tr>
                                        <tr>
                                            <td style="border:1px solid #ddd; padding:8px; color:black;">Producto</td>
                                            <td style="border:1px solid #ddd; padding:8px; color:black;">${product.titulo}</td>
                                        </tr>
                                        <tr>
                                            <td style="border:1px solid #ddd; padding:8px; color:black;">Categor√≠a</td>
                                            <td style="border:1px solid #ddd; padding:8px; color:black;">${product.categoria}</td>
                                        </tr>
                                        <tr>
                                            <td style="border:1px solid #ddd; padding:8px; color:black;">Descripci√≥n</td>
                                            <td style="border:1px solid #ddd; padding:8px; color:black;">${product.descripcion}</td>
                                        </tr>
                                    </table>
                                </div>
                                <div id="tab-contenido" class="tab-content" style="display:none; margin-top:10px;">
                                    ${product.descripcion}
                                </div>
                            </div>
                        </div>
                        <div class="right-column" style="flex:0 0 30%; text-align:left; padding:0;">
                            <img src="imagenes/${product.portada}" alt="Portada ${product.titulo}" style="width:100%; border-top-left-radius:10px; border-top-right-radius:10px; border-bottom-left-radius:0; border-bottom-right-radius:0; display:block; margin-bottom:0;">
                            <div style="padding:15px;">
                                <h2 style="color:#ff007f; margin-bottom:10px;">${product.titulo}</h2>
                                <p><strong>DESCRIPCI√ìN DEL PRODUCTO:</strong></p>
                                <p>${product.descripcion_corta}</p>
                                <p><strong>FECHA DE LANZAMIENTO:</strong></p>
                                <p>${product.fecha_lanzamiento}</p>
                                <p><strong>PRECIO:</strong></p>
                                <p style="font-size:24px; color:#ff007f;">S/${product.precio} PEN</p>
                            </div>
                            <button onclick="addToCart(${product.id})" style="width:100%; padding:15px 0; background-color:#ff007f; color:white; border:none; border-bottom-left-radius:10px; border-bottom-right-radius:10px; border-top-left-radius:0; border-top-right-radius:0; cursor:pointer; font-size:18px; display:block;">Comprar ${product.titulo}</button>
                        </div>
                    </div>
                    <div class="bottom-section">
                    </div>
                </div>
            `;

            const modalContent = document.querySelector('.modal-content');
            modalContent.style.backgroundImage = `url('imagenes/${product.fondo}')`;
            modalContent.style.backgroundSize = 'cover';
            modalContent.style.backgroundPosition = 'center';
            modalContent.style.backgroundRepeat = 'no-repeat';

            document.getElementById('productModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        function addToCart(id) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart.push(id);
            localStorage.setItem('cart', JSON.stringify(cart));
            alert('Producto agregado al carrito');
        }

        function changeViewer(type, src) {
            const video = document.getElementById('main-video');
            const image = document.getElementById('main-image');
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach(thumb => thumb.style.borderColor = 'transparent');
            if (type === 'video') {
                video.style.display = 'block';
                image.style.display = 'none';
                event.target.style.borderColor = '#ff007f';
            } else {
                video.style.display = 'none';
                image.style.display = 'block';
                image.src = src;
                event.target.style.borderColor = '#ff007f';
            }
        }

        function showTab(tab) {
            const desc = document.getElementById('tab-descripcion');
            const cont = document.getElementById('tab-contenido');
            const buttons = document.querySelectorAll('.tabs button');
            buttons.forEach(btn => btn.style.background = '#333');
            if (tab === 'descripcion') {
                desc.style.display = 'block';
                cont.style.display = 'none';
                buttons[0].style.background = '#ff007f';
            } else {
                desc.style.display = 'none';
                cont.style.display = 'block';
                buttons[1].style.background = '#ff007f';
            }
        }

        // Load products on page load
        loadProducts();
    </script>
</body>
</html>
