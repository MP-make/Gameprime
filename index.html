<link href="https://fonts.googleapis.com/css2?family=Nabla&family=Sixtyfour+Convergence&display=swap" rel="stylesheet">
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tienda de Videojuegos - GAME PRIME</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://kit.fontawesome.com/f4c52f4663.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body onload="iniciarPagina()">
    <header class="header"> 
        <div class="logo">
            <img src="imagenes/logo.png" alt="logo" class="logo">
        </div>
        <nav> 
            <ul class="nav-links">
                <li><a href="ofertas.html">Ofertas</a></li>
                <li><a href="contactanos.html">Contacto</a></li>
                <li><a href="carrito.html">Carrito</a></li>
                <li><a href="login-registro.html" id="loginLink">Iniciar Sesi√≥n</a></li>
                <li style="display:none;" id="userInfo">
                    <span id="userName" style="color:#ff007f; font-weight:bold;"></span>
                    <button onclick="cerrarSesion()" style="background:#ff007f; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; margin-left:10px;">Cerrar Sesi√≥n</button>
                </li>
            </ul>
            <div class="hamburger" onclick="toggleMenu()">
                <div class="line"></div>
                <div class="line"></div>
                <div class="line"></div>
            </div>
        </nav>
    </header>

    <main class="fondo-0">
        <section class="banner">
            <img id="img_banner" src="imagenes/banner1.jpg" alt="Videojuegos destacados">
        </section>
        
        <!-- Sistema de Filtros Avanzado -->
        <div class="filtros-container">
            <h3><i class="fa fa-filter"></i> Filtrar Juegos</h3>
            <div class="filtros-grid">
                <!-- Filtro por Categor√≠a -->
                <div class="filtro-item">
                    <label for="categoria-juegos"><i class="fa fa-tag"></i> Categor√≠a:</label>
                    <select id="categoria-juegos" onchange="aplicarFiltros()">
                        <option value="">Todas las Categor√≠as</option>
                    </select>
                </div>

                <!-- Filtro por Rango de Precio -->
                <div class="filtro-item">
                    <label for="precio-min"><i class="fa fa-money"></i> Precio:</label>
                    <div class="precio-range">
                        <input type="number" id="precio-min" placeholder="M√≠n" min="0" step="10" onchange="aplicarFiltros()">
                        <span>-</span>
                        <input type="number" id="precio-max" placeholder="M√°x" min="0" step="10" onchange="aplicarFiltros()">
                    </div>
                </div>

                <!-- Filtro por Descuento -->
                <div class="filtro-item">
                    <label for="descuento-min"><i class="fa fa-percent"></i> Descuento m√≠nimo:</label>
                    <select id="descuento-min" onchange="aplicarFiltros()">
                        <option value="0">Todos</option>
                        <option value="10">10% o m√°s</option>
                        <option value="20">20% o m√°s</option>
                        <option value="30">30% o m√°s</option>
                        <option value="50">50% o m√°s</option>
                    </select>
                </div>

                <!-- Filtro por B√∫squeda de Texto -->
                <div class="filtro-item">
                    <label for="buscar-texto"><i class="fa fa-search"></i> Buscar:</label>
                    <input type="text" id="buscar-texto" placeholder="Nombre del juego..." oninput="aplicarFiltros()">
                </div>

                <!-- Ordenar por -->
                <div class="filtro-item">
                    <label for="ordenar-por"><i class="fa fa-sort"></i> Ordenar por:</label>
                    <select id="ordenar-por" onchange="aplicarFiltros()">
                        <option value="">Predeterminado</option>
                        <option value="precio-asc">Precio: Menor a Mayor</option>
                        <option value="precio-desc">Precio: Mayor a Menor</option>
                        <option value="descuento-desc">Mayor Descuento</option>
                        <option value="nombre-asc">Nombre: A-Z</option>
                        <option value="nombre-desc">Nombre: Z-A</option>
                    </select>
                </div>

                <!-- Bot√≥n Limpiar Filtros -->
                <div class="filtro-item">
                    <button class="btn-limpiar-filtros" onclick="limpiarFiltros()">
                        <i class="fa fa-refresh"></i> Limpiar Filtros
                    </button>
                </div>
            </div>
            <div id="resultados-contador" class="resultados-contador"></div>
        </div>

        <section class="productos" id="juegos-lista">
            <div class="grid-layout">   
            </div>    
        </section>
    </main>

    <!-- Modal for product details -->
    <div id="productModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modal-body">
                <!-- Product details will be loaded here -->
            </div>
        </div>
    </div>

    <footer class="pie-pagina">
        <div class="grupo-1">
            <div class="box">
                <figure>
                    <a href="reclamaciones.html">
                        <img src="imagenes/libro_de_reclamaciones.png" alt="libro de reclamaciones">
                    </a>
                </figure>
            </div>
            <div class="box">
                <h2>SOBRE NOSOTROS</h2>
                <p>Nuestra idea nace de la experiencia propia al comprar videojuegos, garantizando confianza porque hemos estado en tu lugar.</p>
                <p>Fundada en 2024, nos comprometemos a ofrecer siempre las mejores ofertas.</p>
            </div>
            <div class="box">
                <h2>SIGUENOS</h2>
                <div class="red-social">
                    <a href="https://www.facebook.com/?locale=es_LA" class="fa fa-facebook"></a>
                    <a href="https://www.instagram.com/" class="fa fa-instagram"></a>
                    <a href="https://x.com/?lang=es" class="fa fa-twitter"></a>
                    <a href="https://www.youtube.com/" class="fa fa-youtube"></a>
                </div>
            </div>
        </div>
        <div class="grupo-2">
            <small>&copy; 2024 <b>GAME PRIME</b> - Todos los Derechos Reservados.</small>
        </div>
    </footer>
    <script src="script_sesion.js"></script>
    <script src="script.js"></script>
    <script>
        // Verificar sesi√≥n activa al cargar la p√°gina
        function verificarSesion() {
            const userEmail = localStorage.getItem('user_email');
            const userNombre = localStorage.getItem('user_nombre');
            const userRol = localStorage.getItem('user_rol');

            if (userEmail && userNombre) {
                // Usuario tiene sesi√≥n activa
                console.log('‚úÖ Sesi√≥n activa detectada:', userEmail, 'Rol:', userRol);
                document.getElementById('loginLink').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userName').textContent = '¬°Hola, ' + userNombre + '!';
            } else {
                // No hay sesi√≥n
                console.log('‚ùå No hay sesi√≥n activa');
                document.getElementById('loginLink').style.display = 'block';
                document.getElementById('userInfo').style.display = 'none';
            }
        }

        function cerrarSesion() {
            // Limpiar localStorage
            localStorage.removeItem('supabase_session');
            localStorage.removeItem('user_email');
            localStorage.removeItem('user_rol');
            localStorage.removeItem('user_nombre');
            
            console.log('üîì Sesi√≥n cerrada');
            alert('Sesi√≥n cerrada correctamente');
            
            // Redirigir al login
            window.location.href = 'login-registro.html';
        }

        // Verificar sesi√≥n al cargar la p√°gina
        verificarSesion();

        let products = [];
        let categories = [];

        // Cargar categor√≠as desde la base de datos
        async function loadCategories() {
            try {
                const response = await fetch('/api/categorias');
                if (response.ok) {
                    categories = await response.json();
                    const select = document.getElementById('categoria-juegos');
                    select.innerHTML = '<option value="">Todos los Juegos</option>';
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.nombre.toLowerCase();
                        option.textContent = cat.nombre;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Funci√≥n de filtrado
        function filtrarJuegos() {
            const categoriaSeleccionada = document.getElementById('categoria-juegos').value;
            const productoItems = document.querySelectorAll('.producto-item');
            
            productoItems.forEach(item => {
                const categoriaProducto = item.getAttribute('data-categoria');
                if (categoriaSeleccionada === '' || categoriaProducto === categoriaSeleccionada) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/productos');
                products = await response.json();
                const container = document.getElementById('juegos-lista').querySelector('.grid-layout');
                container.innerHTML = '';
                products.forEach(producto => {
                    const div = document.createElement('div');
                    div.className = 'producto-item';
                    div.setAttribute('data-categoria', producto.categoria.toLowerCase());
                    
                    // Calcular precio con descuento
                    const precioOriginal = parseFloat(producto.precio);
                    const descuento = parseFloat(producto.descuento) || 0;
                    const precioFinal = descuento > 0 ? (precioOriginal - (precioOriginal * descuento / 100)).toFixed(2) : precioOriginal.toFixed(2);
                    
                    div.innerHTML = `
                        <div class="producto-imagen">
                            <img src="imagenes/${producto.portada}" alt="${producto.titulo}">
                            ${descuento > 0 ? `<div class="descuento-badge">-${descuento}%</div>` : ''}
                        </div>
                        <div class="producto-info">
                            <h3>${producto.titulo}</h3>
                            <p class="producto-categoria">${producto.categoria}</p>
                            <div class="producto-precio">
                                ${descuento > 0 ? `<span class="precio-original">S/ ${precioOriginal.toFixed(2)}</span>` : ''}
                                <span class="precio-final">S/ ${precioFinal}</span>
                            </div>
                            <button onclick="showProductModal(${producto.id})" class="btn-ver-mas">Ver Detalles</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        function showProductModal(id) {
            const product = products.find(p => p.id == id);
            if (!product) return;

            // Calcular precio con descuento
            const precioOriginal = parseFloat(product.precio);
            const descuento = parseFloat(product.descuento) || 0;
            const precioFinal = descuento > 0 ? (precioOriginal - (precioOriginal * descuento / 100)).toFixed(2) : precioOriginal.toFixed(2);

            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <div class="modal-producto-container">
                    <div class="modal-izquierda">
                        <!-- Visor principal (video o imagen) -->
                        <div class="visor-principal">
                            <video id="main-video" controls>
                                <source src="video/${product.video}" type="video/mp4">
                                Tu navegador no soporta videos.
                            </video>
                            <img id="main-image" alt="Imagen del producto">
                        </div>
                        
                        <!-- Miniaturas -->
                        <div class="galeria-miniaturas">
                            <div class="miniatura active" onclick="changeViewer('video')">
                                <i class="fa fa-play-circle"></i>
                                <span>Video</span>
                            </div>
                            <img src="imagenes/${product.imagen1}" class="miniatura" onclick="changeViewer('image', 'imagenes/${product.imagen1}')" alt="Imagen 1">
                            <img src="imagenes/${product.imagen2}" class="miniatura" onclick="changeViewer('image', 'imagenes/${product.imagen2}')" alt="Imagen 2">
                            <img src="imagenes/${product.imagen3}" class="miniatura" onclick="changeViewer('image', 'imagenes/${product.imagen3}')" alt="Imagen 3">
                            <img src="imagenes/${product.imagen4}" class="miniatura" onclick="changeViewer('image', 'imagenes/${product.imagen4}')" alt="Imagen 4">
                        </div>
                        
                        <!-- Pesta√±as de informaci√≥n -->
                        <div class="info-tabs">
                            <div class="tabs-header">
                                <button class="tab-btn active" onclick="showTab('descripcion')">
                                    <i class="fa fa-info-circle"></i> Descripci√≥n
                                </button>
                                <button class="tab-btn" onclick="showTab('especificaciones')">
                                    <i class="fa fa-list"></i> Especificaciones
                                </button>
                            </div>
                            <div class="tabs-content">
                                <div id="tab-descripcion" class="tab-pane active">
                                    <h3>Acerca de este juego</h3>
                                    <p>${product.descripcion || 'Sin descripci√≥n disponible'}</p>
                                </div>
                                <div id="tab-especificaciones" class="tab-pane">
                                    <table class="tabla-specs">
                                        <tr>
                                            <td><strong>T√≠tulo:</strong></td>
                                            <td>${product.titulo}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Categor√≠a:</strong></td>
                                            <td>${product.categoria}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Fecha de Lanzamiento:</strong></td>
                                            <td>${product.fecha_lanzamiento}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Precio:</strong></td>
                                            <td>S/ ${precioOriginal.toFixed(2)}</td>
                                        </tr>
                                        ${descuento > 0 ? `
                                        <tr>
                                            <td><strong>Descuento:</strong></td>
                                            <td class="descuento-text">${descuento}% OFF</td>
                                        </tr>` : ''}
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-derecha">
                        <div class="producto-portada">
                            <img src="imagenes/${product.portada}" alt="${product.titulo}">
                            ${descuento > 0 ? `<div class="badge-descuento-modal">-${descuento}%</div>` : ''}
                        </div>
                        
                        <div class="producto-detalles">
                            <h2 class="producto-titulo-modal">${product.titulo}</h2>
                            <p class="producto-categoria-modal">
                                <i class="fa fa-tag"></i> ${product.categoria}
                            </p>
                            
                            <div class="producto-descripcion-corta">
                                <p>${product.descripcion_corta || 'Descripci√≥n breve del producto'}</p>
                            </div>
                            
                            <div class="producto-fecha">
                                <i class="fa fa-calendar"></i>
                                <strong>Fecha de Lanzamiento:</strong><br>
                                ${product.fecha_lanzamiento}
                            </div>
                            
                            <div class="producto-precio-modal">
                                ${descuento > 0 ? `
                                    <div class="precio-con-descuento">
                                        <span class="precio-tachado">S/ ${precioOriginal.toFixed(2)}</span>
                                        <span class="precio-actual">S/ ${precioFinal}</span>
                                        <span class="ahorro-text">Ahorras S/ ${(precioOriginal - precioFinal).toFixed(2)}</span>
                                    </div>
                                ` : `
                                    <span class="precio-actual">S/ ${precioFinal}</span>
                                `}
                            </div>
                            
                            <button onclick="addToCart(${product.id})" class="btn-comprar-modal">
                                <i class="fa fa-shopping-cart"></i> Agregar al Carrito
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const modalContent = document.querySelector('.modal-content');
            if (product.fondo) {
                modalContent.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('imagenes/${product.fondo}')`;
                modalContent.style.backgroundSize = 'cover';
                modalContent.style.backgroundPosition = 'center';
                modalContent.style.backgroundRepeat = 'no-repeat';
            }

            document.getElementById('productModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('productModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        function addToCart(id) {
            // Obtener carrito actual
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            
            // Agregar producto
            cart.push(id);
            localStorage.setItem('cart', JSON.stringify(cart));
            
            // Forzar que se guarde en localStorage inmediatamente
            console.log('‚úÖ Producto agregado al carrito:', id);
            console.log('üì¶ Carrito actual:', cart);
            
            // Buscar el producto para mostrar su nombre
            const product = products.find(p => p.id === id);
            const productName = product ? product.titulo : 'Producto';
            
            // Mensaje de confirmaci√≥n con opci√≥n de ir al carrito
            const goToCart = confirm(`‚úÖ ¬°${productName} agregado al carrito!\n\n¬øDeseas ir al carrito ahora?`);
            
            if (goToCart) {
                // Peque√±o delay para asegurar que localStorage se guard√≥
                setTimeout(() => {
                    window.location.href = 'carrito.html';
                }, 100);
            } else {
                // Cerrar el modal si el usuario quiere seguir comprando
                closeModal();
            }
        }

        function changeViewer(type, src) {
            const video = document.getElementById('main-video');
            const image = document.getElementById('main-image');
            const miniaturas = document.querySelectorAll('.miniatura');
            
            // Resetear borde de todas las miniaturas
            miniaturas.forEach(thumb => thumb.classList.remove('active'));
            
            if (type === 'video') {
                video.style.display = 'block';
                image.style.display = 'none';
                // Marcar la miniatura de video como activa
                miniaturas[0].classList.add('active');
            } else {
                video.style.display = 'none';
                image.style.display = 'block';
                image.src = src;
                // Marcar la miniatura clickeada como activa
                event.currentTarget.classList.add('active');
            }
        }

        function showTab(tab) {
            const tabDescripcion = document.getElementById('tab-descripcion');
            const tabEspecificaciones = document.getElementById('tab-especificaciones');
            const buttons = document.querySelectorAll('.tab-btn');
            
            // Remover clase active de todos los botones y tabs
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (tab === 'descripcion') {
                tabDescripcion.classList.add('active');
                tabEspecificaciones.classList.remove('active');
                buttons[0].classList.add('active');
            } else if (tab === 'especificaciones') {
                tabDescripcion.classList.remove('active');
                tabEspecificaciones.classList.add('active');
                buttons[1].classList.add('active');
            }
        }

        // Load products on page load
        loadCategories();
        loadProducts();
    </script>
</body>
</html>
