<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Inicio de Sesión - Game Prime</title>
    <link rel="stylesheet" href="inicio.css">
</head>
<body>

<nav> 
    <ul class="nav-links">
        <li><a href="indexinicio.html">Inicio</a></li>
        <li><a href="#contacto">Contacto</a></li>
        <li><a href="carrito.html">Carrito</a></li>
        <li><a href="login-registro.html">Iniciar Sesión</a></li>
        <li><a href="admin.html">Admin</a></li>
    </ul>
    <div class="hamburger" onclick="toggleMenu()">
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
    </div>
</nav>

<div id="productos-container"></div>

<!-- Modal for product details -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div id="modal-body">
            <!-- Product details will be loaded here -->
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    const rol = localStorage.getItem('rol');

    if (!token) {
        // Hide cart link
        const cartLi = document.querySelector('nav ul li a[href="carrito.html"]').parentElement;
        if (cartLi) cartLi.style.display = 'none';
    } else {
        // Add logout link
        const navUl = document.querySelector('nav ul');
        const logoutLi = document.createElement('li');
        logoutLi.innerHTML = '<a href="#" onclick="logout()">Cerrar Sesión</a>';
        navUl.appendChild(logoutLi);
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('rol');
        location.reload();
    }

    async function loadProducts() {
        try {
            const response = await fetch('/api/productos');
            if (!response.ok) {
                throw new Error('Error al cargar productos');
            }
            const data = await response.json();
            const container = document.getElementById('productos-container');
            container.innerHTML = '';
            data.slice(0, 8).forEach(product => {  // Limit to 8 for home page
                const productDiv = document.createElement('div');
                productDiv.className = 'producto';
                productDiv.innerHTML = `
                    <img src="imagenes/${product.portada}" alt="${product.titulo}">
                    <h3>${product.titulo}</h3>
                    <p>${product.descripcion_corta}</p>
                    <p>S/${product.precio}</p>
                    <button onclick="viewProduct(${product.id})">Ver Detalles</button>
                    <button onclick="addToCart(${product.id})">Agregar al Carrito</button>
                `;
                container.appendChild(productDiv);

                // Disable buttons if not logged in
                if (!token) {
                    productDiv.querySelectorAll('button').forEach(btn => {
                        if (btn.textContent.includes('Agregar al Carrito')) {
                            btn.disabled = true;
                            btn.textContent = 'Inicia Sesión para Comprar';
                            btn.onclick = () => location.href = 'login-registro.html';
                        }
                    });
                }
            });
        } catch (error) {
            console.error(error);
        }
    }

    function viewProduct(id) {
        // Fetch product details and show modal
        fetchProductDetails(id);
    }

    async function fetchProductDetails(id) {
        try {
            const response = await fetch(`/api/producto/${id}`);
            if (!response.ok) {
                throw new Error('Error al cargar el producto');
            }
            const product = await response.json();

            const modalBody = document.getElementById('modal-body');
            modalBody.innerHTML = `
                <section class="product-details">
                    <video controls style="width:100%; max-width:600px;">
                        <source src="video/${product.video}" type="video/mp4">
                    </video>
                    <div class="related-images" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <img src="imagenes/${product.imagen1}" alt="${product.titulo} 1" style="width:100px; height:100px; object-fit:cover;">
                        <img src="imagenes/${product.imagen2}" alt="${product.titulo} 2" style="width:100px; height:100px; object-fit:cover;">
                        <img src="imagenes/${product.imagen3}" alt="${product.titulo} 3" style="width:100px; height:100px; object-fit:cover;">
                        <img src="imagenes/${product.imagen4}" alt="${product.titulo} 4" style="width:100px; height:100px; object-fit:cover;">
                    </div>
                    <div class="product-description">
                        <table style="width:100%; border-collapse:collapse;">
                            <tr>
                                <th style="border:1px solid #ddd; padding:8px;">Descripción</th>
                                <th style="border:1px solid #ddd; padding:8px;">Contenido</th>
                            </tr>
                            <tr>
                                <td style="border:1px solid #ddd; padding:8px;">Producto</td>
                                <td style="border:1px solid #ddd; padding:8px;">${product.titulo}</td>
                            </tr>
                            <tr>
                                <td style="border:1px solid #ddd; padding:8px;">Categoría</td>
                                <td style="border:1px solid #ddd; padding:8px;">${product.categoria}</td>
                            </tr>
                            <tr>
                                <td style="border:1px solid #ddd; padding:8px;">Descripción</td>
                                <td style="border:1px solid #ddd; padding:8px;">${product.descripcion}</td>
                            </tr>
                        </table>
                    </div>
                </section>
                
                <aside class="product-info" style="margin-top:20px;">
                    <img src="imagenes/${product.portada}" alt="Portada ${product.titulo}" style="width:200px; height:auto;">
                    <p><strong>DESCRIPCIÓN DEL PRODUCTO:</strong></p>
                    <p>${product.descripcion_corta}</p>
                    <p><strong>FECHA DE LANZAMIENTO:</strong></p>
                    <p>${product.fecha_lanzamiento}</p>
                    <p><strong>PRECIO:</strong></p>
                    <p>S/${product.precio} PEN</p>
                    <button onclick="addToCart(${product.id})">Comprar ${product.titulo}</button>
                </aside>
            `;

            // Disable buy button if not logged in
            if (!token) {
                const buyBtn = modalBody.querySelector('button[onclick*="addToCart"]');
                if (buyBtn) {
                    buyBtn.disabled = true;
                    buyBtn.textContent = 'Inicia Sesión para Comprar';
                    buyBtn.onclick = () => location.href = 'login-registro.html';
                }
            }

            document.getElementById('productModal').style.display = 'block';
        } catch (error) {
            console.error(error);
            alert('Error al cargar los detalles del producto.');
        }
    }

    function closeModal() {
        document.getElementById('productModal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('productModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    function addToCart(id) {
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        cart.push(id);
        localStorage.setItem('cart', JSON.stringify(cart));
        alert('Producto agregado al carrito');
    }

    window.onload = loadProducts;
</script>
<script src="login.js"></script>
</body>
</html>