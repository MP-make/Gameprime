<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login y Registro - Game Prime</title>
    <link rel="stylesheet" href="inicio.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <style>
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            border-radius: 20px;
            background: transparent; /* Fondo transparente para ver el borde */
            position: relative;
            overflow: hidden; /* Para contener los bordes */
        }
        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
        }
        .tab-button {
            flex: 1;
            padding: 10px;
            padding: 10px;
            background: #333;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        .tab-button.active {
            background: #ff007f;
        }
        .form-container {
            display: none;
        }
        .form-container.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #333;
            color: #fff;
        }
        .btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(45deg, #ff007f, #ff3399);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s, transform 0.3s;
            font-weight: bold;
        }
        .btn:hover {
            background: linear-gradient(45deg, #ff3399, #ff66b2);
            transform: scale(1.05);
        }

        /* Esta es la capa de la sombra/brillo que gira */
        .auth-container::before {
          content: "";
          position: absolute;
          top: -2px;
          left: -2px;
          right: -2px;
          bottom: -2px;
          background: linear-gradient(45deg, #ff007f, #ff3399, #ff66b2, #ff007f);
          border-radius: 22px;
          z-index: -1;
          animation: rotating 4s linear infinite;
        }

        /* Esta es la nueva capa de fondo (reemplaza la anterior) */
        .auth-container::after {
          content: "";
          position: absolute;
          inset: 4px; /* Separaci√≥n del borde */
          background: #2d2d39; /* Color de fondo oscuro de la imagen */
          border-radius: 15px;
          border: 8px solid #25252b;
          z-index: 1; /* Para que est√© sobre el brillo */
        }

        /* --- 3. A√ëADE EL KEYFRAME PARA LA ANIMACI√ìN --- */
        @keyframes rotating {
          from {
            transform: rotate(0deg);
          }
          to {
            transform: rotate(360deg);
          }
        }

        /* --- 4. AJUSTA EL CONTENIDO DEL FORMULARIO --- */
        /* Debemos poner el formulario por encima de la capa ::after */
        .tab-buttons, .form-container {
            position: relative;
            z-index: 2;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('login')">Iniciar Sesi√≥n</button>
            <button class="tab-button" onclick="showTab('register')">Registrarse</button>
        </div>
        <div id="login" class="form-container active">
            <h2>Inicia Sesi√≥n üéÆ</h2>
            <form id="loginForm">
                <div class="form-group">
                    <input type="email" id="loginEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="Contrase√±a" required>
                </div>
                <button type="submit" class="btn">Entrar</button>
            </form>
        </div>
        <div id="register" class="form-container">
            <h2>Reg√≠strate üéÆ</h2>
            <form id="registerForm">
                <div class="form-group">
                    <input type="email" id="registerEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="registerPassword" placeholder="Contrase√±a" required>
                </div>
                <button type="submit" class="btn">Registrarse</button>
            </form>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://ukzadyiieylaaekxblpk.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVremFkeWlpZXlsYWFla3hibHBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMzExOTgsImV4cCI6MjA3ODkwNzE5OH0.JRmxRCO8FNvw6Ix89Rd6CSK82o8jod2iCQhCk98LvN8';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function showTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.form-container').forEach(form => form.classList.remove('active'));
            document.querySelector(`button[onclick="showTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                // Autenticar con Supabase
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    alert('Error: ' + error.message);
                    return;
                }

                const user = data.user;
                console.log('‚úÖ Usuario autenticado:', user.email);

                // Guardar sesi√≥n en localStorage
                localStorage.setItem('supabase_session', JSON.stringify(data.session));
                localStorage.setItem('user_email', user.email);

                // Obtener el rol del usuario desde la base de datos
                const response = await fetch(`/api/usuarios?correo=${encodeURIComponent(user.email)}`);
                console.log('üì° Response status:', response.status);
                
                if (response.ok) {
                    const userData = await response.json();
                    console.log('üë§ Datos del usuario:', userData);
                    const rol = userData.rol;
                    const nombre = userData.nombre || user.email.split('@')[0];
                    
                    console.log('üîë Rol obtenido:', rol);
                    console.log('üìõ Nombre:', nombre);

                    // Guardar rol y nombre en localStorage
                    localStorage.setItem('user_rol', rol);
                    localStorage.setItem('user_nombre', nombre);

                    // Redirigir seg√∫n el rol
                    if (rol === 'admin') {
                        console.log('üîß Redirigiendo a admin.html');
                        window.location.href = 'admin.html';
                    } else {
                        // Para 'cliente' o cualquier otro rol, redirigir a index
                        console.log('üéÆ Redirigiendo a index.html (cliente con sesi√≥n)');
                        window.location.href = 'index.html';
                    }
                } else {
                    console.error('‚ùå Error al obtener rol, status:', response.status);
                    const errorText = await response.text();
                    console.error('Error text:', errorText);
                    alert('‚ö†Ô∏è Usuario autenticado pero no encontrado en la base de datos.\n\nPor favor:\n1. Ve a Supabase Dashboard\n2. Tabla "usuarios"\n3. Agrega tu email: ' + user.email + '\n4. Con rol: "admin" o "usuario"');
                }
            } catch (error) {
                console.error('‚ùå Error en login:', error);
                alert('Error de conexi√≥n: ' + error.message);
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;

            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('‚ùå Por favor ingresa un email v√°lido');
                return;
            }

            // Validar longitud de contrase√±a
            if (password.length < 6) {
                alert('‚ùå La contrase√±a debe tener al menos 6 caracteres');
                return;
            }

            console.log('üìß Intentando registrar:', email);

            try {
                // Primero verificar si el usuario ya existe en la BD
                const checkResponse = await fetch(`/api/usuarios?correo=${encodeURIComponent(email)}`);
                if (checkResponse.ok) {
                    alert('‚ö†Ô∏è Este email ya est√° registrado. Por favor inicia sesi√≥n.');
                    showTab('login');
                    return;
                }

                // Extraer nombre del email (antes del @)
                const nombre = email.split('@')[0];

                // PRIMERO: Crear usuario en la tabla usuarios con rol 'cliente'
                console.log('üìù Creando usuario en BD primero...');
                const createUserResponse = await fetch('/api/usuarios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        nombre: nombre, 
                        correo: email, 
                        rol: 'cliente'
                    })
                });

                if (!createUserResponse.ok) {
                    const errorData = await createUserResponse.json();
                    console.error('‚ùå Error al crear usuario en BD:', errorData);
                    alert('‚ùå Error al crear el usuario: ' + (errorData.error || 'Error desconocido'));
                    return;
                }

                console.log('‚úÖ Usuario creado en BD');

                // SEGUNDO: Registrar en Supabase Auth
                console.log('üîê Registrando en Supabase Auth...');
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        emailRedirectTo: window.location.origin,
                        data: {
                            nombre: nombre,
                            rol: 'cliente'
                        }
                    }
                });

                console.log('üìä Respuesta de Supabase Auth:', { data, error });

                if (error) {
                    console.error('‚ùå Error de Supabase Auth:', error);
                    
                    // Mensajes de error m√°s amigables
                    if (error.message.includes('invalid')) {
                        alert('‚ùå Email inv√°lido. Por favor verifica que el formato sea correcto (ejemplo: usuario@dominio.com)');
                    } else if (error.message.includes('already registered')) {
                        alert('‚ö†Ô∏è Este email ya est√° registrado. Intenta iniciar sesi√≥n o usa otro email.');
                    } else {
                        alert('‚ùå Error al registrar en autenticaci√≥n: ' + error.message);
                    }
                    return;
                }

                console.log('‚úÖ Usuario registrado completamente');
                alert('‚úÖ ¬°Registro exitoso!\n\nüìß Se ha enviado un email de confirmaci√≥n a: ' + email + '\n\n‚ú® Ya puedes iniciar sesi√≥n mientras confirmas tu cuenta.');
                
                // Auto-completar el formulario de login
                document.getElementById('loginEmail').value = email;
                showTab('login');

            } catch (error) {
                console.error('‚ùå Error en registro:', error);
                alert('‚ùå Error de conexi√≥n: ' + error.message);
            }
        });
    </script>
</body>
</html>